services:
  autocrop:
    image: pytorch/pytorch:2.5.1-cuda12.4-cudnn9-devel
    container_name: autocropimage
    working_dir: /workspace
    volumes:
      - .:/workspace
      - ./wheels:/wheels:ro
    ports:
      - "6000:6006"
    environment:
      - PYTHONUNBUFFERED=1
      - TORCH_HOME=/root/.cache/torch/hub
      - PIP_INDEX_URL=https://pypi.tuna.tsinghua.edu.cn/simple
      - CONDA_SSL_VERIFY=false
    gpus: all
    command: >
      bash -lc "set -e; apt-get update && apt-get install -y git git-lfs && git lfs install || true; if [ -d .git ]; then git lfs pull || true; fi; TH=${TORCH_HOME:-/root/.cache/torch/hub}; mkdir -p $TH/checkpoints $TH/hub/checkpoints; for f in /workspace/*.pth; do [ -f \"$f\" ] || continue; size=$(stat -c %s \"$f\"); if [ \"$size\" -gt 1000000 ]; then cp -n \"$f\" $TH/checkpoints/; cp -n \"$f\" $TH/hub/checkpoints/; fi; done; ln -sfn $TH/checkpoints $TH/hub/checkpoints || true; if [ -d /wheels ] && ls /wheels/*.whl >/dev/null 2>&1; then pip install --no-index --find-links /wheels -r requirements.txt || true; else pip install --no-cache-dir --default-timeout=120 -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple || pip install --no-cache-dir --default-timeout=120 -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple || pip install --no-cache-dir --default-timeout=120 -r requirements.txt -i https://pypi.douban.com/simple; fi; python -c 'import cv2' || pip install --no-cache-dir --default-timeout=120 opencv-python-headless==4.12.0.88 -i https://pypi.tuna.tsinghua.edu.cn/simple || pip install --no-cache-dir --default-timeout=120 opencv-python-headless==4.12.0.88 -i https://mirrors.aliyun.com/pypi/simple || pip install --no-cache-dir --default-timeout=120 opencv-python-headless==4.12.0.88 -i https://pypi.douban.com/simple; python setup.py install; uvicorn apiServer:app --host 0.0.0.0 --port 6006"