version: "3.9"

services:
  autocrop:
    image: pytorch/pytorch:2.5.1-cuda12.4-cudnn9-devel
    container_name: autocropimage
    working_dir: /workspace
    volumes:
      - .:/workspace
    ports:
      - "6000:6006"
    environment:
      - PYTHONUNBUFFERED=1
      - TORCH_HOME=/root/.cache/torch/hub
      - PIP_INDEX_URL=https://pypi.tuna.tsinghua.edu.cn/simple
    gpus: all
    command: >
      bash -lc "mkdir -p /root/.cache/torch/hub/checkpoints && cp -n /workspace/*.pth /root/.cache/torch/hub/checkpoints/ 2>/dev/null || true && conda install -y -c conda-forge fastapi uvicorn pydantic numpy pillow opencv || true && pip install --no-cache-dir -r requirements.txt || true && python -c 'import cv2' || pip install --no-cache-dir opencv-python-headless==4.12.0.88 || true && python setup.py install && uvicorn apiServer:app --host 0.0.0.0 --port 6006"