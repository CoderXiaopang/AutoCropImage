version: "3.9"

services:
  autocrop_cpu:
    image: pytorch/pytorch:2.5.1-cpu
    container_name: autocropimage-cpu
    working_dir: /workspace
    volumes:
      - .:/workspace
    ports:
      - "6000:6006"
    environment:
      - PYTHONUNBUFFERED=1
      - TORCH_HOME=/root/.cache/torch/hub
      - PIP_INDEX_URL=https://pypi.tuna.tsinghua.edu.cn/simple
      - CONDA_SSL_VERIFY=false
    command: >
      bash -lc "mkdir -p /root/.cache/torch/hub/checkpoints && cp -n /workspace/*.pth /root/.cache/torch/hub/checkpoints/ 2>/dev/null || true && conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge && conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main && conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free && conda config --add channels https://mirrors.ustc.edu.cn/anaconda/pkgs/main && conda config --add channels https://mirrors.ustc.edu.cn/anaconda/cloud/conda-forge && conda config --set show_channel_urls yes && conda config --set channel_priority flexible && (conda install -y fastapi uvicorn pydantic numpy pillow opencv || true) && (pip install --no-cache-dir --default-timeout=60 -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple || pip install --no-cache-dir --default-timeout=60 -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple || pip install --no-cache-dir --default-timeout=60 -r requirements.txt -i https://pypi.douban.com/simple) && (python -c 'import cv2' || pip install --no-cache-dir --default-timeout=60 opencv-python-headless==4.12.0.88 -i https://pypi.tuna.tsinghua.edu.cn/simple || pip install --no-cache-dir --default-timeout=60 opencv-python-headless==4.12.0.88 -i https://mirrors.aliyun.com/pypi/simple || pip install --no-cache-dir --default-timeout=60 opencv-python-headless==4.12.0.88 -i https://pypi.douban.com/simple) && python setup.py install && uvicorn apiServer:app --host 0.0.0.0 --port 6006"